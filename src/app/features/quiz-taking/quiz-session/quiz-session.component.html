<div class="quiz-session" appPullToRefresh (refresh)="onRefresh()">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading()">
    <div class="spinner"></div>
    <p>Loading quiz...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error()">
    <h2>Error</h2>
    <p>{{ error() }}</p>
    <button class="btn btn-primary" (click)="finishQuiz()">Back to Home</button>
  </div>

  <!-- Completion Screen -->
  <div class="completion-screen" *ngIf="showCompletion() && quiz()">
    <div class="completion-card">
      <div class="completion-icon">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>

      <h1>Quiz Abgeschlossen!</h1>
      <p class="subtitle">{{ quiz()!.title }}</p>

      <div class="completion-stats">
        <div class="stat-card">
          <div class="stat-value">{{ allQuestionsWithProgress().length }}</div>
          <div class="stat-label">Fragen insgesamt</div>
        </div>
        <div class="stat-card">
          <div class="stat-value stat-wrong">{{ wrongQuestionCount() }}</div>
          <div class="stat-label">Fehler</div>
        </div>
      </div>

      <div class="completion-actions">
        <button
          class="btn btn-primary btn-large"
          *ngIf="wrongQuestionCount() > 0"
          (click)="startReviewMode()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
          Fehler wiederholen ({{ wrongQuestionCount() }})
        </button>

        <button
          class="btn btn-secondary btn-large"
          (click)="exitToHome()">
          Zur Startseite
        </button>
      </div>

      <div class="review-hint" *ngIf="wrongQuestionCount() === 0">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        <p>Perfekt! Alle Fragen richtig beantwortet!</p>
      </div>
    </div>
  </div>

  <!-- Quiz Content -->
    <div class="quiz-content" *ngIf="!isLoading() && !error() && !showCompletion() && quiz()">
      <!-- Header -->
      <div class="quiz-header">
        <div class="header-left">
          <p class="eyebrow">
            {{ isReviewMode() ? 'Wiederholungsmodus' : 'Quiz Session' }}
            <span class="review-badge" *ngIf="isReviewMode()">üéØ</span>
          </p>
          <h1>{{ quiz()!.title }}</h1>
          <p class="quiz-description" *ngIf="quiz()!.description">{{ quiz()!.description }}</p>
        </div>
        <div class="header-right">
          <button
            class="btn btn-secondary mode-toggle"
            (click)="toggleFlashcardMode()"
            [title]="isFlashcardMode() ? 'Zu normalem Modus wechseln' : 'Zu Flashcard-Modus wechseln'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              @if (isFlashcardMode()) {
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="9" y1="9" x2="15" y2="9"/>
                <line x1="9" y1="12" x2="15" y2="12"/>
                <line x1="9" y1="15" x2="13" y2="15"/>
              } @else {
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                <line x1="8" y1="21" x2="16" y2="21"/>
                <line x1="12" y1="17" x2="12" y2="21"/>
              }
            </svg>
            {{ isFlashcardMode() ? 'Normal' : 'Karteikarte' }}
          </button>
          <button class="btn btn-secondary" (click)="exitQuiz()">Exit</button>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="progress()"></div>
      <span class="progress-text">{{ currentIndex() + 1 }} / {{ questionsWithProgress().length }}</span>
    </div>

    <!-- Current Question -->
    <div
      class="question-container"
      *ngIf="currentQuestion()">

      <!-- Flashcard Mode -->
      @if (isFlashcardMode()) {
        <div
          class="flashcard-wrapper"
          appSwipeGesture
          (swipeLeft)="onAnswer(false)"
          (swipeRight)="onAnswer(true)">
          <app-flashcard
            [question]="currentQuestion()!.question"
            [disabled]="showResult()"
            (answerSubmit)="onAnswer($event)">
          </app-flashcard>
        </div>
      } @else {
        <!-- Normal Quiz Mode -->
        <div
          appSwipeGesture
          (swipeLeft)="nextQuestion()"
          (swipeRight)="previousQuestion()">
          <div class="question-header">
            <h2>Question {{ currentIndex() + 1 }}</h2>
            <span class="level-badge level-{{ currentQuestion()!.progress.level }}">
              Level {{ currentQuestion()!.progress.level }}
            </span>
          </div>

          <!-- Swipe hint for mobile users -->
          @if (showSwipeHint()) {
            <div class="swipe-hint">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
              <span>Wische f√ºr vorherige/n√§chste Frage</span>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
              </svg>
              <button class="dismiss-hint" (click)="dismissSwipeHint()" aria-label="Hinweis schlie√üen">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
          }

          <!-- Multiple Choice Question -->
          <app-multiple-choice
            *ngIf="currentQuestion()!.question.type === 'multiple-choice'"
            [question]="$any(currentQuestion()!.question)"
            [showResult]="showResult()"
            [disabled]="showResult()"
            (answerSubmit)="onAnswer($event)">
          </app-multiple-choice>

          <!-- Ordering Question -->
          <app-ordering-question
            *ngIf="currentQuestion()!.question.type === 'ordering'"
            [question]="$any(currentQuestion()!.question)"
            [showResult]="showResult()"
            [disabled]="showResult()"
            (answerSubmit)="onAnswer($event)">
          </app-ordering-question>

          <!-- Matching Question -->
          <app-matching-question
            *ngIf="currentQuestion()!.question.type === 'matching'"
            [question]="$any(currentQuestion()!.question)"
            [showResult]="showResult()"
            [disabled]="showResult()"
            (answerSubmit)="onAnswer($event)">
          </app-matching-question>

          <!-- Result Feedback -->
          <div class="result-feedback" *ngIf="showResult()">
            <div class="feedback-card" [class.correct]="lastAnswerCorrect()" [class.incorrect]="!lastAnswerCorrect()">
              <div class="feedback-icon">
                {{ lastAnswerCorrect() ? '‚úì' : '‚úó' }}
              </div>
              <div class="feedback-text">
                <h3>{{ lastAnswerCorrect() ? 'Correct!' : 'Incorrect' }}</h3>
                <p *ngIf="lastAnswerCorrect()">
                  Great job! Level: {{ currentQuestion()!.progress.level }}
                </p>
                <p *ngIf="!lastAnswerCorrect()">
                  Progress reset. Review the correct answer above.
                </p>
              </div>
              <button class="btn btn-primary btn-large" (click)="nextQuestion()">
                {{ currentIndex() + 1 < questionsWithProgress().length ? 'Next Question' : 'Finish' }}
              </button>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Navigation -->
    <div class="quiz-navigation" *ngIf="!showResult()">
      <button
        class="btn btn-secondary"
        (click)="previousQuestion()"
        [disabled]="currentIndex() === 0">
        ‚Üê Previous
      </button>
      <span class="nav-info">{{ currentIndex() + 1 }} of {{ questionsWithProgress().length }}</span>
    </div>
  </div>
</div>
