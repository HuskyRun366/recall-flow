<div class="quiz-session" appPullToRefresh (refresh)="onRefresh()">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading()">
    <div class="spinner"></div>
    <p>{{ 'quizSession.loading' | translate }}</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error()">
    <h2>{{ 'common.error' | translate }}</h2>
    <p>{{ error() }}</p>
    <button class="btn btn-primary" (click)="finishQuiz()">{{ 'common.backToHome' | translate }}</button>
  </div>

  <!-- Completion Screen -->
  <div class="completion-screen" *ngIf="showCompletion() && quiz()">
    <div class="completion-card">
      <div class="completion-icon">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>

      <h1>{{ 'quizSession.completeTitle' | translate }}</h1>
      <p class="subtitle">{{ quiz()!.title }}</p>

      <div class="completion-stats">
        <app-stat-card [config]="{
          icon: 'svg',
          iconContent: '<path d=\'M9 11H3v9h6v-9Z M21 11h-6v9h6v-9Z M15 5H9v14h6V5Z\'/>',
          value: allQuestionsWithProgress().length,
          label: ('quizSession.stats.totalQuestions' | translate)
        }" />

        <app-stat-card [config]="{
          icon: 'svg',
          iconContent: '<line x1=\'18\' y1=\'6\' x2=\'6\' y2=\'18\'/><line x1=\'6\' y1=\'6\' x2=\'18\' y2=\'18\'/>',
          value: wrongQuestionCount(),
          label: ('quizSession.stats.wrong' | translate),
          variant: 'error'
        }" />
      </div>

      <div class="completion-actions">
        <button
          class="btn btn-primary btn-large"
          *ngIf="wrongQuestionCount() > 0"
          (click)="startReviewMode()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
          {{ 'quizSession.actions.reviewWrong' | translate:{ count: wrongQuestionCount() } }}
        </button>

        <button
          class="btn btn-secondary btn-large"
          (click)="exitToHome()">
          {{ 'common.backToHome' | translate }}
        </button>
      </div>

      <div class="review-hint" *ngIf="wrongQuestionCount() === 0">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        <p>{{ 'quizSession.perfectAllCorrect' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Quiz Content -->
    <div class="quiz-content" *ngIf="!isLoading() && !error() && !showCompletion() && quiz()">
      <!-- Header -->
      <div class="quiz-header">
        <div class="header-left">
	          <p class="eyebrow">
	            {{ isReviewMode() ? ('quizSession.reviewMode' | translate) : ('quizSession.sessionTitle' | translate) }}
	            <span class="review-badge" *ngIf="isReviewMode()">üéØ</span>
	          </p>
          <h1>{{ quiz()!.title }}</h1>
          <p class="quiz-description" *ngIf="quiz()!.description">{{ quiz()!.description }}</p>
        </div>
        <div class="header-right">
	          <button
	            class="btn btn-secondary mode-toggle"
	            (click)="toggleFlashcardMode()"
	            [title]="isFlashcardMode() ? ('quizSession.flashcardMode.switchToNormal' | translate) : ('quizSession.flashcardMode.switchToFlashcard' | translate)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              @if (isFlashcardMode()) {
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="9" y1="9" x2="15" y2="9"/>
                <line x1="9" y1="12" x2="15" y2="12"/>
                <line x1="9" y1="15" x2="13" y2="15"/>
              } @else {
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                <line x1="8" y1="21" x2="16" y2="21"/>
                <line x1="12" y1="17" x2="12" y2="21"/>
              }
            </svg>
	            {{ isFlashcardMode() ? ('quizSession.flashcardMode.normal' | translate) : ('quizSession.flashcardMode.flashcard' | translate) }}
	          </button>
	          <button class="btn btn-secondary" (click)="exitQuiz()">{{ 'common.exit' | translate }}</button>
	      </div>
	    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="progress()"></div>
      <span class="progress-text">{{ currentIndex() + 1 }} / {{ questionsWithProgress().length }}</span>
    </div>

    <!-- Current Question -->
    <div
      class="question-container"
      *ngIf="currentQuestion()">

      <!-- Flashcard Mode -->
      @if (isFlashcardMode()) {
        <div
          class="flashcard-wrapper"
          appSwipeGesture
          (swipeLeft)="onAnswer(false)"
          (swipeRight)="onAnswer(true)">
          <app-flashcard
            [question]="currentQuestion()!.question"
            [disabled]="showResult()"
            (answerSubmit)="onAnswer($event)">
          </app-flashcard>
        </div>
      } @else {
        <!-- Normal Quiz Mode -->
        <div
          appSwipeGesture
          (swipeLeft)="nextQuestion()"
          (swipeRight)="previousQuestion()">
          <div class="question-header">
            <h2>{{ 'quizSession.questionNumber' | translate:{ number: currentIndex() + 1 } }}</h2>
            <span class="level-badge level-{{ currentQuestion()!.progress.level }}">
              {{ 'flashcard.level' | translate }} {{ currentQuestion()!.progress.level }}
            </span>
          </div>
          <div class="adaptive-meta" *ngIf="adaptiveInfo() as info">
            <span class="adaptive-pill" [class.due]="info.isDue">
              {{ info.isDue
                ? ('quizSession.adaptive.dueNow' | translate)
                : ('quizSession.adaptive.dueIn' | translate:{ days: info.dueInDays }) }}
            </span>
            <span class="adaptive-pill">
              {{ 'quizSession.adaptive.forgetIn' | translate:{ days: info.forgetInDays } }}
            </span>
            <span class="adaptive-pill">
              {{ 'quizSession.adaptive.difficulty' | translate:{ label: (info.difficultyLabelKey | translate) } }}
            </span>
          </div>

          <!-- Swipe hint for mobile users -->
          @if (showSwipeHint()) {
            <div class="swipe-hint">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
	              </svg>
	              <span>{{ 'quizSession.swipeHint' | translate }}</span>
	              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                <path d="M9 18l6-6-6-6"/>
	              </svg>
	              <button class="dismiss-hint" (click)="dismissSwipeHint()" [attr.aria-label]="'common.close' | translate">
	                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                  <line x1="18" y1="6" x2="6" y2="18"/>
	                  <line x1="6" y1="6" x2="18" y2="18"/>
	                </svg>
	              </button>
            </div>
          }

          <!-- Multiple Choice Question -->
          <app-multiple-choice
            *ngIf="currentQuestion()!.question.type === 'multiple-choice'"
            [question]="$any(currentQuestion()!.question)"
            [showResult]="showResult()"
            [disabled]="showResult()"
            (answerSubmit)="onAnswer($event)">
          </app-multiple-choice>

          <!-- Ordering Question -->
          <app-ordering-question
            *ngIf="currentQuestion()!.question.type === 'ordering'"
            [question]="$any(currentQuestion()!.question)"
            [showResult]="showResult()"
            [disabled]="showResult()"
            (answerSubmit)="onAnswer($event)">
          </app-ordering-question>

          <!-- Matching Question -->
          <app-matching-question
            *ngIf="currentQuestion()!.question.type === 'matching'"
            [question]="$any(currentQuestion()!.question)"
            [showResult]="showResult()"
            [disabled]="showResult()"
            (answerSubmit)="onAnswer($event)">
          </app-matching-question>

          <!-- Result Feedback -->
          <div class="result-feedback" *ngIf="showResult()">
            <div class="feedback-card" [class.correct]="lastAnswerCorrect()" [class.incorrect]="!lastAnswerCorrect()">
              <div class="feedback-icon">
                {{ lastAnswerCorrect() ? '‚úì' : '‚úó' }}
	              </div>
	              <div class="feedback-text">
	                <h3>{{ lastAnswerCorrect() ? ('quizSession.result.correct' | translate) : ('quizSession.result.incorrect' | translate) }}</h3>
	                <p *ngIf="lastAnswerCorrect()">
	                  {{ 'quizSession.result.greatJob' | translate:{ level: currentQuestion()!.progress.level } }}
	                </p>
	                <p *ngIf="!lastAnswerCorrect()">
	                  {{ 'quizSession.result.reviewCorrect' | translate }}
	                </p>
	              </div>
	              <button class="btn btn-primary btn-large" (click)="nextQuestion()">
	                {{ currentIndex() + 1 < questionsWithProgress().length ? ('quizSession.actions.nextQuestion' | translate) : ('common.finish' | translate) }}
	              </button>
	            </div>
	          </div>
        </div>
      }
    </div>

    <!-- Navigation -->
	    <div class="quiz-navigation" *ngIf="!showResult()">
	      <button
	        class="btn btn-secondary"
	        (click)="previousQuestion()"
	        [disabled]="currentIndex() === 0">
	        ‚Üê {{ 'common.previous' | translate }}
	      </button>
	      <span class="nav-info">{{ 'quizSession.nav.of' | translate:{ current: currentIndex() + 1, total: questionsWithProgress().length } }}</span>
	    </div>
  </div>
</div>
