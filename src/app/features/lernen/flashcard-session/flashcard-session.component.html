<div class="session-container">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'session.loading' | translate }}</p>
    </div>
  } @else if (error()) {
    <!-- Error State -->
    <div class="error-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <h2>{{ 'session.error' | translate }}</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="goToDeck()">{{ 'session.backToDecks' | translate }}</button>
    </div>
  } @else if (isCompleted()) {
    <!-- Completion Screen -->
    <div class="completion-screen">
      <div class="completion-header">
        <div class="completion-icon">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <h1>{{ 'session.complete' | translate }}</h1>
        <p class="completion-subtitle">{{ deck()?.title }}</p>
      </div>

      <div class="completion-stats">
        <app-stat-card [config]="{
          icon: 'svg',
          iconContent: '<polyline points=\'20 6 9 17 4 12\'/>',
          value: correctAnswers(),
          label: ('session.known' | translate),
          variant: 'success'
        }" />

        <app-stat-card [config]="{
          icon: 'svg',
          iconContent: '<line x1=\'18\' y1=\'6\' x2=\'6\' y2=\'18\'/><line x1=\'6\' y1=\'6\' x2=\'18\' y2=\'18\'/>',
          value: incorrectAnswers(),
          label: ('session.unknown' | translate),
          variant: 'error'
        }" />

        <app-stat-card [config]="{
          icon: 'svg',
          iconContent: '<rect x=\'2\' y=\'7\' width=\'20\' height=\'14\' rx=\'2\'/><path d=\'M2 11h20\'/>',
          value: totalCards(),
          label: ('session.totalCards' | translate),
          variant: 'total'
        }" />

        <app-stat-card [config]="{
          icon: 'svg',
          iconContent: '<path d=\'M12 2v20M2 12h20\'/>',
          value: getSuccessRate() + '%',
          label: ('session.successRate' | translate)
        }" />
      </div>

      <div class="completion-actions">
        <button class="btn btn-primary" (click)="restartSession()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="1 4 1 10 7 10"/>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
          </svg>
          {{ 'session.studyAgain' | translate }}
        </button>
        <button class="btn btn-secondary" (click)="editDeck()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          {{ 'flashcard.editDeck' | translate }}
        </button>
        <button class="btn btn-secondary" (click)="goToDeck()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          {{ 'session.backToDecks' | translate }}
        </button>
      </div>
    </div>
  } @else {
    <!-- Active Session -->
    <div class="session-header">
      <div class="header-left">
        <button class="back-button" (click)="goToDeck()" [attr.aria-label]="'session.backToDecks' | translate">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <div class="deck-info">
          <h2>{{ deck()?.title }}</h2>
          <p class="card-counter">{{ 'session.cardOf' | translate:{ current: currentCardIndex() + 1, total: totalCards() } }}</p>
        </div>
      </div>

      <div class="header-right">
        @if (currentCard() && currentCard()!.progress) {
          <div class="current-level" [style.background]="getLevelColor(currentCard()!.progress!.level)">
            {{ 'flashcard.level' | translate }} {{ currentCard()!.progress!.level }}
          </div>
        }
        @if (adaptiveInfo(); as info) {
          <div class="adaptive-meta">
            <span class="adaptive-pill" [class.due]="info.isDue">
              {{ info.isDue
                ? ('session.adaptive.dueNow' | translate)
                : ('session.adaptive.dueIn' | translate:{ days: info.dueInDays }) }}
            </span>
            <span class="adaptive-pill">
              {{ 'session.adaptive.forgetIn' | translate:{ days: info.forgetInDays } }}
            </span>
            <span class="adaptive-pill">
              {{ 'session.adaptive.difficulty' | translate:{ label: (info.difficultyLabelKey | translate) } }}
            </span>
          </div>
        }
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progress()"></div>
      </div>
      <span class="progress-text">{{ 'session.percentComplete' | translate:{ percent: progress() } }}</span>
    </div>

    <!-- Flashcard -->
    @if (currentCard()) {
      <div class="flashcard-container">
        <app-flashcard
          [question]="currentCard()!.question"
          (answerSubmit)="handleAnswer($event)">
        </app-flashcard>
      </div>
    }

    <!-- Keyboard Shortcuts Hint -->
    <div class="shortcuts-hint">
      <p>
        <span>{{ 'session.shortcuts.title' | translate }}:</span>
        <kbd>Space</kbd>/<kbd>Enter</kbd> {{ 'session.shortcuts.flip' | translate }} •
        <kbd>→</kbd>/<kbd>Y</kbd> {{ 'session.shortcuts.known' | translate }} •
        <kbd>←</kbd>/<kbd>N</kbd> {{ 'session.shortcuts.unknown' | translate }}
      </p>
    </div>

    <!-- Session Stats -->
    <div class="session-stats">
      <div class="stat-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        <span>{{ correctAnswers() }} {{ 'session.known' | translate }}</span>
      </div>
      <div class="stat-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        <span>{{ incorrectAnswers() }} {{ 'session.unknown' | translate }}</span>
      </div>
      <div class="stat-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="7" width="20" height="14" rx="2"/>
        </svg>
        <span>{{ cardsRemaining() }} {{ 'session.remaining' | translate }}</span>
      </div>
    </div>
  }
</div>
