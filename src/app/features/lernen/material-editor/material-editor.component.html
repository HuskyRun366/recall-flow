<div class="material-editor">
  <!-- Header -->
  <div class="editor-header">
    <div class="header-left">
      <p class="eyebrow">
        {{ 'materials.editor.eyebrow' | translate }}
        @if (unsavedChanges()) {
          â€¢ {{ 'common.unsaved' | translate }}
        }
      </p>
      <h1>
        @if (material()?.title) {
          {{ material()!.title }}
        } @else {
          {{ 'materials.newMaterial' | translate }}
        }
        @if (unsavedChanges()) {
          *
        }
      </h1>
      <p class="subtitle">{{ formatBytes(htmlContent().length) }}</p>
    </div>
    <div class="header-right">
      <button
        class="btn btn-secondary"
        (click)="togglePreview()"
        [disabled]="isLoading() || !htmlContent()">
        {{ (showPreview() ? 'materials.editor.view.editor' : 'materials.editor.view.preview') | translate }}
      </button>
      <button
        class="btn btn-primary"
        (click)="saveMaterial()"
        [disabled]="isLoading() || isSaving() || (!unsavedChanges() && !isNewMaterial())">
        {{ (isSaving() ? 'common.saving' : 'common.save') | translate }}
      </button>
      <button
        class="btn btn-secondary"
        (click)="goBack()"
        [disabled]="isSaving()">
        {{ 'common.cancel' | translate }}
      </button>
    </div>
  </div>

  <!-- Error State -->
  @if (error()) {
    <div class="error-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <h2>{{ 'common.error' | translate }}</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="retry()">
        {{ 'common.retry' | translate }}
      </button>
    </div>
  }

  <!-- Success Message -->
  @if (successMessage()) {
    <div class="success-toast">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
      {{ successMessage() }}
    </div>
  }

  <!-- Co-Author Errors -->
  @if (coAuthorErrors().length > 0) {
    <div class="error-message co-author-errors">
      <strong>{{ 'quiz.editor.coAuthorIssues' | translate }}:</strong>
      <ul>
        @for (err of coAuthorErrors(); track err) {
          <li>{{ err }}</li>
        }
      </ul>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>{{ 'materials.editor.loading' | translate }}</p>
    </div>
  }

  <!-- Editor Content -->
  @if (!isLoading() && !error() && material()) {
    <div class="editor-layout">
      <!-- Sidebar: Settings -->
      <div class="sidebar">
        <div class="settings-card">
          <h3>{{ 'common.settings' | translate }}</h3>

          <div class="form-group">
            <label>{{ 'common.title' | translate }}</label>
            <input
              type="text"
              name="materialTitle"
              autocomplete="off"
              [(ngModel)]="material()!.title"
              (ngModelChange)="materialForm.patchValue({title: $event}); unsavedChanges.set(true)"
              [placeholder]="'materials.editor.placeholders.title' | translate">
          </div>

          <div class="form-group">
            <label>{{ 'common.description' | translate }}</label>
            <textarea
              name="materialDescription"
              autocomplete="off"
              [(ngModel)]="material()!.description"
              (ngModelChange)="materialForm.patchValue({description: $event}); unsavedChanges.set(true)"
              [placeholder]="'common.descriptionPlaceholder' | translate"
              rows="3"></textarea>
          </div>

          <div class="form-group">
            <label>{{ 'common.tags' | translate }}</label>
            <input
              type="text"
              name="materialTags"
              autocomplete="off"
              [value]="(material()?.tags || []).join(', ')"
              (input)="materialForm.patchValue({tags: $any($event.target).value}); unsavedChanges.set(true)"
              [placeholder]="'common.tagsPlaceholder' | translate">
          </div>

          <div class="form-group">
            <label>{{ 'common.visibility' | translate }}</label>
            <select
              name="materialVisibility"
              [value]="material()?.visibility || 'private'"
              (change)="materialForm.patchValue({visibility: $any($event.target).value}); unsavedChanges.set(true)">
              <option value="private">{{ 'quiz.visibility.private' | translate }}</option>
              <option value="public">{{ 'quiz.visibility.public' | translate }}</option>
              <option value="unlisted">{{ 'materials.editor.visibility.unlistedWithCode' | translate }}</option>
            </select>
          </div>
        </div>

        <div class="coauthor-card">
          <div class="coauthor-header">
            <div>
              <p class="eyebrow">{{ 'common.coAuthors' | translate }}</p>
              <h4>{{ 'common.addCollaborators' | translate }}</h4>
            </div>
            <span class="pill">{{ 'common.optional' | translate }}</span>
          </div>

          <div class="coauthor-input">
            <label for="materialCoAuthors">{{ 'common.coAuthorsHint' | translate }}</label>
            <textarea id="materialCoAuthors" name="materialCoAuthors"
              [value]="coAuthors().join(', ')"
              [disabled]="!isOwner()"
              (input)="onCoAuthorInput($any($event.target).value)"
              rows="2"
              [placeholder]="'common.coAuthorsPlaceholder' | translate"></textarea>
            <small>{{ 'common.coAuthorsNote' | translate }}</small>
          </div>

          @if (coAuthors().length) {
            <div class="coauthor-list">
              @for (mail of coAuthors(); track mail) {
                <div class="chip">{{ mail }}</div>
              }
            </div>
          }
        </div>

        <!-- Delete Button (only for owner of existing material) -->
        @if (!isNewMaterial() && isOwner()) {
          <button
            class="btn btn-danger btn-full"
            (click)="deleteMaterial()"
            [disabled]="isSaving()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            {{ 'materials.deleteMaterial' | translate }}
          </button>
        }
      </div>

      <!-- Main Area: Upload/Editor/Preview -->
      <div class="main-area">
        @if (!showPreview()) {
          <!-- Upload Zone -->
          <div
            class="upload-zone"
            [class.dragging]="isDragging()"
            [class.has-content]="!!htmlContent()"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            (click)="triggerFileInput()">

            <input
              #fileInput
              type="file"
              accept=".html,.htm"
              (change)="onFileSelect($event)"
              hidden>

            @if (!htmlContent()) {
              <div class="upload-content">
                <div class="upload-icon">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                </div>
                <h3>{{ 'materials.editor.upload.dropTitle' | translate }}</h3>
                <p>{{ 'materials.editor.upload.dropSubtitle' | translate }}</p>
                <span class="file-hint">{{ 'materials.editor.upload.hint' | translate }}</span>
              </div>
            } @else {
              <div class="upload-content has-file">
                <div class="file-info">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                  </svg>
                  <div>
                    <span class="file-name">
                      @if (fileName()) {
                        {{ fileName() }}
                      } @else {
                        {{ 'materials.editor.upload.defaultFileName' | translate }}
                      }
                    </span>
                    <span class="file-size">{{ formatBytes(htmlContent().length) }}</span>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" (click)="$event.stopPropagation()">
                  {{ 'materials.editor.upload.chooseAnother' | translate }}
                </button>
              </div>
            }
          </div>

          <!-- HTML Editor with CodeMirror -->
          <div class="html-editor">
            <div class="editor-toolbar">
              <span class="toolbar-label">{{ 'materials.editor.htmlContentLabel' | translate }}</span>
              <span class="char-count">{{ htmlContent().length.toLocaleString() }} {{ 'materials.editor.characters' | translate }}</span>
            </div>
            <div #editorContainer class="codemirror-container"></div>
          </div>
        } @else {
          <!-- Preview -->
          <div class="preview-container">
            <div class="preview-header">
              <h3>{{ 'materials.editor.preview.title' | translate }}</h3>
              <button class="btn btn-secondary btn-small" (click)="togglePreview()">
                {{ 'materials.editor.preview.backToEditor' | translate }}
              </button>
            </div>
            @if (sanitizedPreview()) {
              <iframe
                class="preview-frame"
                [srcdoc]="sanitizedPreview()"
                sandbox="allow-scripts allow-forms allow-modals allow-popups"
                [title]="'materials.editor.preview.iframeTitle' | translate">
              </iframe>
            } @else {
              <div class="preview-empty">
                <p>{{ 'materials.editor.preview.empty' | translate }}</p>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- Unsaved Changes Indicator -->
  <div class="unsaved-indicator" *ngIf="unsavedChanges()">
    <span class="dot"></span>
    {{ 'common.unsavedChanges' | translate }}
  </div>
</div>
