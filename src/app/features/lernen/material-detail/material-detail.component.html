<div class="material-detail-page" *ngIf="!isLoading(); else loading" appPullToRefresh (refresh)="onRefresh()">
  <ng-container *ngIf="material(); else errorBlock">
    <div class="hero-card">
      <div class="hero-left">
        <div class="avatar">{{ material()!.title.charAt(0).toUpperCase() }}</div>
        <div>
          <p class="eyebrow">{{ 'materials.title' | translate }}</p>
          <h1>{{ material()!.title }}</h1>
          <p class="subtitle" *ngIf="material()!.description">{{ material()!.description }}</p>
          <div class="badges">
            <app-badge [config]="{
              variant: material()!.visibility === 'public' ? 'public' : material()!.visibility === 'unlisted' ? 'unlisted' : 'private',
              label: material()!.visibility === 'public' ? ('quiz.visibility.public' | translate) : material()!.visibility === 'unlisted' ? ('quiz.visibility.unlisted' | translate) : ('quiz.visibility.private' | translate)
            }" />
          </div>
          <div class="author-section" *ngIf="materialAuthor()">
            <a [routerLink]="['/profile', material()!.ownerId]" class="author-link">
              <img
                [src]="materialAuthor()!.photoURL || 'assets/default-avatar.svg'"
                [alt]="materialAuthor()!.displayName"
                class="author-avatar" />
              <span class="author-name">{{ materialAuthor()!.displayName }}</span>
            </a>
            <app-follow-button
              *ngIf="material()!.ownerId !== currentUser()?.uid"
              [userId]="material()!.ownerId"
              [compact]="true" />
          </div>
        </div>
      </div>
      <div class="hero-actions">
        <ng-container *ngIf="requiresEnrollment(); else directView">
          <button class="btn btn-secondary"
                  [disabled]="enrollState() !== 'idle' || isEnrolled()"
                  (click)="enroll()">
            {{ enrollState() === 'loading' ? ('common.adding' | translate) : (isEnrolled() ? ('common.added' | translate) : ('common.add' | translate)) }}
          </button>
          <button class="btn btn-secondary"
                  *ngIf="isEnrolled()"
                  [disabled]="enrollState() === 'removing'"
                  (click)="unenroll()">
            {{ enrollState() === 'removing' ? ('common.removing' | translate) : ('common.remove' | translate) }}
          </button>
          <button class="btn btn-primary"
                  [disabled]="!canView()"
                  (click)="viewMaterial()">
            {{ 'materials.viewMaterial' | translate }}
          </button>
        </ng-container>
        <ng-template #directView>
          <button class="btn btn-primary" (click)="viewMaterial()">{{ 'materials.viewMaterial' | translate }}</button>
        </ng-template>
        <button class="btn btn-secondary" *ngIf="canEdit()" (click)="editMaterial()">{{ 'common.edit' | translate }}</button>
      </div>
    </div>

    <div class="stats-grid">
      <app-stat-card [config]="{
        icon: 'svg',
        iconContent: '<path d=\'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\'/><polyline points=\'14 2 14 8 20 8\'/>',
        value: formatBytes(material()!.contentSize),
        label: ('materials.list.size' | translate)
      }" />

      <app-stat-card [config]="{
        icon: 'svg',
        iconContent: '<rect x=\'3\' y=\'4\' width=\'18\' height=\'18\' rx=\'2\' ry=\'2\'/><line x1=\'16\' y1=\'2\' x2=\'16\' y2=\'6\'/><line x1=\'8\' y1=\'2\' x2=\'8\' y2=\'6\'/><line x1=\'3\' y1=\'10\' x2=\'21\' y2=\'10\'/>',
        value: formatDate(material()!.updatedAt),
        label: ('common.lastUpdated' | translate)
      }" />

      <app-stat-card [config]="{
        icon: 'svg',
        iconContent: '<path d=\'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\'/><circle cx=\'12\' cy=\'7\' r=\'4\'/>',
        value: material()!.metadata.totalStudents,
        label: ('discover.users' | translate)
      }" />

      <div class="stat-card" *ngIf="material()!.joinCode">
        <div class="stat-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
          </svg>
        </div>
        <div>
          <div class="stat-value">
            {{ material()!.joinCode }}
            <button class="copy-btn" (click)="copyJoinCode()" [title]="copySuccess() ? ('common.copied' | translate) : ('common.copyCode' | translate)">
              {{ copySuccess() ? '‚úì' : 'üìã' }}
            </button>
          </div>
          <div class="stat-label">{{ 'join.codeLabel' | translate }}</div>
        </div>
      </div>
    </div>

    @if (coAuthors().length > 0) {
      <div class="card coauthors-card">
        <div class="card-header">
          <h2>{{ 'common.coAuthors' | translate }} ({{ coAuthors().length }})</h2>
        </div>
        <div class="coauthors-list">
          @for (coAuthor of coAuthors(); track coAuthor.userId) {
            <div class="coauthor-item">
              <div class="coauthor-avatar">
                {{ (coAuthor.email || 'U').charAt(0).toUpperCase() }}
              </div>
              <div class="coauthor-info">
                <div class="coauthor-email">{{ coAuthor.email }}</div>
                <div class="coauthor-meta">
                  {{ 'common.addedOn' | translate:{ date: formatDate(coAuthor.invitedAt) } }}
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Ratings & Reviews Section -->
    <div class="card reviews-card" *ngIf="material()!.visibility === 'public'">
      <div class="card-header">
        <h2>{{ 'discover.rating.title' | translate }}</h2>
        <button
          type="button"
          class="rating-chip"
          *ngIf="isEnrolled() || canEdit()"
          (click)="openReviewDialog()"
          [attr.aria-label]="'discover.rating.rate' | translate">
          <span class="icon" aria-hidden="true">‚≠ê</span>
          <span class="label">{{ 'discover.rating.rate' | translate }}</span>
        </button>
      </div>

      <div class="rating-summary">
        <div class="rating-average">
          <span class="rating-value">{{ (material()!.averageRating || 0) | number:'1.1-1' }}</span>
          <app-star-rating [rating]="material()!.averageRating || 0" [count]="material()!.ratingCount || 0" size="md" />
        </div>
      </div>
    </div>
  </ng-container>
</div>

<!-- Review Dialog -->
<app-review-dialog
  *ngIf="showReviewDialog() && material()"
  [contentId]="material()!.id"
  [contentType]="'material'"
  [contentTitle]="material()!.title"
  [existingReview]="userReview()"
  (optimisticChange)="onReviewOptimistic($event)"
  (close)="closeReviewDialog()"
  (submitted)="onReviewSubmitted()"
/>

<ng-template #loading>
  <div class="loading-state">
    <div class="spinner"></div>
    <p>{{ 'common.loading' | translate }}</p>
  </div>
</ng-template>

<ng-template #errorBlock>
  <div class="error-state">
    {{ error() ? error() : ('errors.loadingFailed' | translate) }}
  </div>
</ng-template>
