<div class="lernen-page">
  <div class="page-header">
    <div class="title-block">
      <p class="eyebrow">Übersicht</p>
      <h1>Meine Lernkarten</h1>
      <p class="subtitle">Lerne mit Spaced Repetition</p>
    </div>

    <div class="header-actions">
      <a routerLink="/lernen/deck-editor/new" class="btn btn-secondary">
        Neues Deck erstellen
      </a>
    </div>
  </div>

  <div class="stats-summary">
    <div class="stat-card">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M3 9h18"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalDecks() }}</div>
        <div class="stat-label">Decks</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="7" width="20" height="14" rx="2"/>
          <path d="M2 11h20"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalCards() }}</div>
        <div class="stat-label">Karten</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ overallProgress() }}%</div>
        <div class="stat-label">Fortschritt</div>
      </div>
    </div>
  </div>

  @if (!isLoading() && !error()) {
    <div class="search-bar">
      <div class="search-field">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input
          type="search"
          #deckSearch
          [value]="searchTerm()"
          (input)="searchTerm.set(deckSearch.value)"
          placeholder="Decks durchsuchen"
          aria-label="Decks durchsuchen" />
        <button
          type="button"
          class="clear-btn"
          *ngIf="searchTerm()"
          (click)="searchTerm.set('')">Zurücksetzen</button>
      </div>
      <div class="result-count">{{ filteredDecks().length }} Ergebnis{{ filteredDecks().length === 1 ? '' : 'se' }}</div>
    </div>
  }

  @if (isLoading()) {
    <div class="skeleton-grid">
      @for (item of [1,2,3,4,5,6]; track item) {
        <app-skeleton-loader type="card" />
      }
    </div>
  } @else if (error()) {
    <div class="error-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <h2>Fehler beim Laden</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="retry()">Erneut versuchen</button>
    </div>
  } @else {
    <div class="deck-grid">
      @if (filteredDecks().length === 0) {
        <div class="empty-state">
          <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="2" y="7" width="20" height="14" rx="2"/>
            <path d="M2 11h20"/>
          </svg>
          <h2>Keine Decks gefunden</h2>
          <p>
            {{ searchTerm().trim() ? 'Kein Deck passt zu deiner Suche.' : 'Du hast noch keine Decks erstellt. Lege mit "Neues Deck erstellen" los.' }}
          </p>
        </div>
      } @else {
        @for (deckWithProgress of filteredDecks(); track deckWithProgress.deck.id) {
          <div class="deck-card">
            <div class="deck-card-header">
              <div class="deck-avatar">
                {{ (deckWithProgress.deck.title || 'D').substring(0, 1).toUpperCase() }}
              </div>

              <div class="header-text">
                <div class="title-row">
                  <h3>{{ deckWithProgress.deck.title }}</h3>
                  <span
                    class="badge"
                    [ngClass]="{
                      'badge-public': deckWithProgress.deck.visibility === 'public',
                      'badge-unlisted': deckWithProgress.deck.visibility === 'unlisted',
                      'badge-private': deckWithProgress.deck.visibility !== 'public' && deckWithProgress.deck.visibility !== 'unlisted'
                    }">
                    @if (deckWithProgress.deck.visibility === 'public') {
                      Öffentlich
                    } @else if (deckWithProgress.deck.visibility === 'unlisted') {
                      Nicht gelistet
                    } @else {
                      Privat
                    }
                  </span>
                </div>

                <p class="deck-description" *ngIf="deckWithProgress.deck.description">
                  {{ deckWithProgress.deck.description }}
                </p>
              </div>
            </div>

            <div class="deck-meta">
              <div class="meta-item">
                <div class="meta-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2"/>
                    <path d="M2 11h20"/>
                  </svg>
                </div>
                <div class="meta-copy">
                  <span class="meta-label">Karten</span>
                  <span class="meta-value">{{ deckWithProgress.totalCards }}</span>
                </div>
              </div>

              <div class="meta-item">
                <div class="meta-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                </div>
                <div class="meta-copy">
                  <span class="meta-label">Fortschritt</span>
                  <span class="meta-value">{{ deckWithProgress.progress.completionRate }}%</span>
                </div>
              </div>

              <div class="meta-item">
                <div class="meta-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                </div>
                <div class="meta-copy">
                  <span class="meta-label">Zu lernen</span>
                  <span class="meta-value">{{ deckWithProgress.progress.level0Count }}</span>
                </div>
              </div>
            </div>

            <div class="deck-actions">
              <button
                class="btn btn-primary btn-small"
                [routerLink]="['/lernen/deck', deckWithProgress.deck.id, 'study']">
                Deck lernen
              </button>

              @if (deckWithProgress.userCanEdit) {
                <button
                  class="btn btn-secondary btn-small"
                  [routerLink]="['/lernen/deck-editor', deckWithProgress.deck.id]">
                  Bearbeiten
                </button>
                <button
                  class="btn btn-danger btn-small"
                  (click)="deleteDeck(deckWithProgress.deck.id, deckWithProgress.deck.title)"
                  title="Deck löschen">
                  Löschen
                </button>
              }
            </div>
          </div>
        }
      }
    </div>
  }

  <div class="fab-container" [class.open]="fabOpen()">
    <div class="fab-menu">
      <a class="fab-item" routerLink="/lernen/deck-editor/new" (click)="toggleFab()">
        <span class="icon-circle">➕</span>
        <span class="label">Neues Deck</span>
      </a>
    </div>

    <button class="fab"
            type="button"
            (click)="toggleFab()"
            [attr.aria-expanded]="fabOpen()"
            aria-label="Erstellen-Menü öffnen"
            aria-haspopup="menu">
      <span class="fab-lines" aria-hidden="true"></span>
    </button>
  </div>
</div>
