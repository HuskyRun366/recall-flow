<div class="flashcard-editor">
  <!-- Header -->
  <div class="editor-header">
    <div class="header-left">
      <p class="eyebrow">
        {{ 'flashcard.editor.eyebrow' | translate }}
        @if (unsavedChanges()) {
          â€¢ {{ 'common.unsaved' | translate }}
        }
      </p>
      <h1>
        @if (deck()?.title) {
          {{ deck()!.title }}
        } @else {
          {{ 'flashcard.editor.defaultTitle' | translate }}
        }
        @if (unsavedChanges()) {
          *
        }
      </h1>
      <p class="subtitle">{{ cards().length }} {{ (cards().length === 1 ? 'common.card' : 'common.cards') | translate }}</p>
    </div>
    <div class="header-right">
      <button
        class="btn btn-secondary"
        (click)="openImportDialog()"
        [disabled]="isLoading() || isSaving()">
        ðŸ“¥ {{ 'common.import' | translate }}
      </button>
      <button
        class="btn btn-primary"
        (click)="saveDeck()"
        [disabled]="isLoading() || isSaving() || !unsavedChanges()">
        {{ (isSaving() ? 'common.saving' : 'common.save') | translate }}
      </button>
      <button
        class="btn btn-secondary"
        (click)="goBack()"
        [disabled]="isSaving()">
        {{ 'common.cancel' | translate }}
      </button>
    </div>
  </div>

  <!-- Error State -->
  @if (error()) {
    <div class="error-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <h2>{{ 'errors.loadingFailed' | translate }}</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="retry()">
        {{ 'common.retry' | translate }}
      </button>
    </div>
  }

  <!-- Co-Author Errors -->
  @if (coAuthorErrors().length > 0) {
    <div class="error-message co-author-errors">
      <strong>{{ 'quiz.editor.coAuthorIssues' | translate }}:</strong>
      <ul>
        @for (err of coAuthorErrors(); track err) {
          <li>{{ err }}</li>
        }
      </ul>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>{{ 'flashcard.editor.loading' | translate }}</p>
    </div>
  }

  <!-- Editor Content -->
  @if (!isLoading() && !error() && deck()) {
    <div class="editor-layout">
      <!-- Sidebar: Deck Settings -->
      <div class="sidebar">
        <div class="deck-settings-card">
          <h3>{{ 'flashcard.editor.settingsTitle' | translate }}</h3>

          <div class="form-group">
            <label>{{ 'common.title' | translate }}</label>
            <input
              type="text"
              name="deckTitle"
              autocomplete="off"
              [(ngModel)]="deck()!.title"
              (ngModelChange)="updateDeckMetadata('title', $event)"
              [placeholder]="'flashcard.editor.placeholders.title' | translate">
          </div>

          <div class="form-group">
            <label>{{ 'common.description' | translate }}</label>
            <textarea
              name="deckDescription"
              autocomplete="off"
              [(ngModel)]="deck()!.description"
              (ngModelChange)="updateDeckMetadata('description', $event)"
              [placeholder]="'common.descriptionPlaceholder' | translate"
              rows="3"></textarea>
          </div>

          <div class="form-group">
            <label>{{ 'common.visibility' | translate }}</label>
            <select
              name="deckVisibility"
              [value]="deck()?.visibility || 'private'"
              (change)="updateDeckMetadata('visibility', $any($event.target).value)">
              <option value="private">{{ 'quiz.visibility.private' | translate }}</option>
              <option value="public">{{ 'quiz.visibility.public' | translate }}</option>
              <option value="unlisted">{{ 'quiz.visibility.unlisted' | translate }}</option>
            </select>
          </div>
        </div>

        <div class="coauthor-card">
          <div class="coauthor-header">
            <div>
              <p class="eyebrow">{{ 'common.coAuthors' | translate }}</p>
              <h4>{{ 'common.addCollaborators' | translate }}</h4>
            </div>
            <span class="pill">{{ 'common.optional' | translate }}</span>
          </div>

          <div class="coauthor-input">
            <label for="deckCoAuthors">{{ 'common.coAuthorsHint' | translate }}</label>
            <textarea id="deckCoAuthors" name="deckCoAuthors"
              [value]="coAuthors().join(', ')"
              [disabled]="!isOwner()"
              (input)="onCoAuthorInput($any($event.target).value)"
              rows="2"
              [placeholder]="'common.coAuthorsPlaceholder' | translate"></textarea>
            <small>{{ 'common.coAuthorsNote' | translate }}</small>
          </div>

          @if (coAuthors().length) {
            <div class="coauthor-list">
              @for (mail of coAuthors(); track mail) {
                <div class="chip">{{ mail }}</div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Main Area: Flashcards -->
      <div class="main-area">
        <!-- Cards Header -->
        <div class="cards-header">
          <div class="cards-title">
            <h2>{{ 'common.cards' | translate }}</h2>
            <span class="card-count">{{ cards().length }} {{ (cards().length === 1 ? 'common.card' : 'common.cards') | translate }}</span>
          </div>
          <button class="btn btn-primary" (click)="addCard()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            {{ 'flashcard.editor.addCard' | translate }}
          </button>
        </div>

        <!-- Empty State -->
        @if (cards().length === 0) {
          <div class="empty-cards-state">
            <div class="empty-icon">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="7" width="18" height="13" rx="2"/>
                <path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </div>
            <h3>{{ 'flashcard.noCardsTitle' | translate }}</h3>
            <p>{{ 'flashcard.noCardsMessage' | translate }}</p>
            <div class="empty-actions">
              <button class="btn btn-primary" (click)="addCard()">
                {{ 'flashcard.editor.createFirstCard' | translate }}
              </button>
              <button class="btn btn-secondary" (click)="openImportDialog()">
                {{ 'flashcard.editor.importCards' | translate }}
              </button>
            </div>
          </div>
        }

        <!-- Cards Grid -->
        @if (cards().length > 0) {
          <div class="cards-grid">
            <div
              *ngFor="let card of cards(); let i = index; trackBy: trackByCard"
              class="flashcard-preview"
              [class.selected]="selectedCardIndex() === i"
              (click)="selectCard(i)">

              <div class="flashcard-preview-header">
                <span class="card-number">#{{ i + 1 }}</span>
              </div>

              <div class="flashcard-preview-content">
                <div class="preview-side front">
                  <span class="side-label">{{ 'flashcard.front' | translate | uppercase }}</span>
                  <p>
                    @if (card.front) {
                      {{ card.front }}
                    } @else {
                      {{ 'common.empty' | translate }}
                    }
                  </p>
                </div>
                <div class="preview-divider">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </div>
                <div class="preview-side back">
                  <span class="side-label">{{ 'flashcard.back' | translate | uppercase }}</span>
                  <p>
                    @if (card.back) {
                      {{ card.back }}
                    } @else {
                      {{ 'common.empty' | translate }}
                    }
                  </p>
                </div>
              </div>

              <div class="flashcard-preview-actions">
                <button
                  class="action-btn edit-btn"
                  (click)="selectCard(i); $event.stopPropagation()"
                  [title]="'common.edit' | translate">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button
                  class="action-btn delete-btn"
                  (click)="deleteCard(i); $event.stopPropagation()"
                  [disabled]="isSaving()"
                  [title]="'common.delete' | translate">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Card Editor Modal (when card is selected) -->
    @if (selectedCardIndex() !== null && cards()[selectedCardIndex()!]) {
      <div class="editor-modal-overlay" (click)="selectedCardIndex.set(null)">
        <div class="editor-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>{{ 'flashcard.editor.editCardTitle' | translate:{ number: (selectedCardIndex()! + 1) } }}</h3>
            <button class="close-btn" (click)="selectedCardIndex.set(null)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label for="cardFront">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
                {{ 'flashcard.editor.fields.frontLabel' | translate }}
              </label>
              <textarea
                id="cardFront"
                name="cardFront"
                [ngModel]="cards()[selectedCardIndex()!].front"
                (ngModelChange)="updateCardField(selectedCardIndex()!, 'front', $event)"
                [placeholder]="'flashcard.editor.placeholders.front' | translate"
                rows="5"></textarea>
            </div>

            <div class="form-group">
              <label for="cardBack">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                </svg>
                {{ 'flashcard.editor.fields.backLabel' | translate }}
              </label>
              <textarea
                id="cardBack"
                name="cardBack"
                [ngModel]="cards()[selectedCardIndex()!].back"
                (ngModelChange)="updateCardField(selectedCardIndex()!, 'back', $event)"
                [placeholder]="'flashcard.editor.placeholders.back' | translate"
                rows="5"></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              (click)="selectedCardIndex.set(null)">
              {{ 'common.close' | translate }}
            </button>
            <button
              class="btn btn-danger"
              (click)="deleteCard(selectedCardIndex()!); selectedCardIndex.set(null)"
              [disabled]="isSaving()">
              {{ 'common.delete' | translate }}
            </button>
          </div>
        </div>
      </div>
    }
  }

  <!-- Unsaved Changes Indicator -->
  <div class="unsaved-indicator" *ngIf="unsavedChanges()">
    <span class="dot"></span>
    {{ 'common.unsavedChanges' | translate }}
  </div>

  <!-- Import Dialog -->
  <app-import-dialog
    *ngIf="showImportDialog()"
    (importComplete)="handleImportComplete($event)"
    (close)="closeImportDialog()">
  </app-import-dialog>
</div>
