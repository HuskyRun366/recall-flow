<div class="material-list-page" appPullToRefresh (refresh)="onRefresh()">
  <div class="page-header">
    <div class="title-block">
      <p class="eyebrow">{{ 'common.overview' | translate }}</p>
      <h1>{{ 'materials.title' | translate }}</h1>
      <p class="subtitle">{{ 'materials.list.subtitle' | translate }}</p>
    </div>

    <div class="header-actions">
      <button class="btn btn-secondary" type="button" (click)="createNewMaterial()">
        {{ 'materials.newMaterial' | translate }}
      </button>
    </div>
  </div>

  <div class="toolbar-row">
    <div class="tab-group" role="tablist" [attr.aria-label]="'materials.list.categoriesAria' | translate">
      <button
        class="tab-btn"
        role="tab"
        [class.active]="activeTab() === 'owned'"
        [attr.aria-selected]="activeTab() === 'owned'"
        (click)="setActiveTab('owned')">
        {{ 'tabs.owned' | translate }}
        <span class="count">{{ ownedMaterials().length }}</span>
      </button>
      <button
        class="tab-btn"
        role="tab"
        [class.active]="activeTab() === 'co-authored'"
        [attr.aria-selected]="activeTab() === 'co-authored'"
        (click)="setActiveTab('co-authored')">
        {{ 'tabs.coAuthored' | translate }}
        <span class="count">{{ coAuthoredMaterials().length }}</span>
      </button>
      <button
        class="tab-btn"
        role="tab"
        [class.active]="activeTab() === 'public'"
        [attr.aria-selected]="activeTab() === 'public'"
        (click)="setActiveTab('public')">
        {{ 'tabs.public' | translate }}
        <span class="count">{{ publicMaterials().length }}</span>
      </button>
    </div>

    <div class="toolbar-pill">
      <span class="pill">{{ (activeTab() === 'owned' ? 'materials.list.pill.owned' : activeTab() === 'co-authored' ? 'materials.list.pill.coAuthored' : 'materials.list.pill.public') | translate }}</span>
    </div>

    <!-- Join by Code Modal -->
    <div class="join-wrapper">
      <input type="checkbox" id="join-toggle" class="join-toggle" />
      <label for="join-toggle" class="btn btn-secondary join-btn">{{ 'join.joinWithCode' | translate }}</label>

      <div class="join-modal">
        <div class="join-card">
          <h3>{{ 'join.material.title' | translate }}</h3>
          <p>{{ 'join.material.subtitle' | translate }}</p>
          <input type="text"
                 [placeholder]="'join.codePlaceholder' | translate"
                 class="join-input"
                 [attr.aria-label]="'join.material.ariaLabel' | translate"
                 [value]="joinCode()"
                 (input)="joinCode.set($any($event.target).value)" />
          <div class="join-error" *ngIf="joinError()">{{ joinError() }}</div>
          <div class="join-actions">
            <label for="join-toggle" class="btn btn-secondary">{{ 'common.cancel' | translate }}</label>
            <button class="btn btn-primary" type="button"
                    [disabled]="joinBusy()"
                    (click)="joinByCode()">
              {{ joinBusy() ? ('join.joining' | translate) : ('join.join' | translate) }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="stats-summary">
    <app-stat-card [config]="{
      icon: 'svg',
      iconContent: '<path d=\'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\'/><polyline points=\'14 2 14 8 20 8\'/>',
      value: displayedMaterialCount(),
      label: ('nav.materials' | translate)
    }" />

    <app-stat-card [config]="{
      icon: 'svg',
      iconContent: '<path d=\'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\'/><polyline points=\'17 8 12 3 7 8\'/><line x1=\'12\' y1=\'3\' x2=\'12\' y2=\'15\'/>',
      value: totalContentSize(),
      label: ('materials.list.totalSize' | translate)
    }" />

    <app-stat-card [config]="{
      icon: 'svg',
      iconContent: '<path d=\'M22 11.08V12a10 10 0 1 1-5.93-9.14\'/><polyline points=\'22 4 12 14.01 9 11.01\'/>',
      value: latestUpdatedDate() ? formatDate(latestUpdatedDate()!) : '‚Äî',
      label: ('common.lastUpdated' | translate)
    }" />
  </div>

  @if (!isLoading() && !error()) {
    <app-search-bar
      [searchTerm]="currentSearchTerm()"
      [resultCount]="displayedMaterials().length"
      [placeholder]="searchPlaceholder() | translate"
      [ariaLabel]="'materials.list.searchAria' | translate"
      (searchChange)="onSearch($event)"
      (clear)="clearSearch()" />
  }

  @if (isLoading()) {
    <div class="skeleton-grid">
      @for (item of [1,2,3,4,5,6]; track item) {
        <app-skeleton-loader type="card" />
      }
    </div>
  } @else if (error()) {
    <div class="error-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
      </svg>
      <h2>{{ 'errors.loadingFailed' | translate }}</h2>
      <p>{{ error() }}</p>
    </div>
  } @else {
    <div class="material-grid">
      @if (displayedMaterials().length === 0) {
        <div class="empty-state">
          <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          <h2>{{ 'materials.noMaterials' | translate }}</h2>
          <p *ngIf="activeTab() === 'owned'">
            {{ (currentSearchTerm().trim() ? 'materials.list.empty.owned.search' : 'materials.list.empty.owned.none') | translate }}
          </p>
          <p *ngIf="activeTab() === 'co-authored'">
            {{ (currentSearchTerm().trim() ? 'materials.list.empty.coAuthored.search' : 'materials.list.empty.coAuthored.none') | translate }}
          </p>
          <p *ngIf="activeTab() === 'public'">
            {{ (publicSearchTerm().trim() ? 'materials.list.empty.public.search' : 'materials.list.empty.public.none') | translate }}
          </p>
        </div>
      } @else {
        @for (material of displayedMaterials(); track material.id) {
          <div class="material-card">
            <div class="material-card-header">
              <div class="material-avatar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
              </div>

              <div class="header-text">
                <div class="title-row">
                  <h3>{{ material.title }}</h3>
                  <div class="badge-row">
                    <app-badge [config]="{
                      variant: material.visibility === 'public' ? 'public' : material.visibility === 'unlisted' ? 'unlisted' : 'private',
                      label: material.visibility === 'public' ? ('quiz.visibility.public' | translate) : material.visibility === 'unlisted' ? ('quiz.visibility.unlisted' | translate) : ('quiz.visibility.private' | translate)
                    }" />
                    @if (material.visibility === 'unlisted' && material.joinCode && (isOwner(material) || isCoAuthor(material))) {
                      <button
                        class="btn-icon copy-code-btn"
                        (click)="copyJoinCode(material); $event.stopPropagation()"
                        [title]="'materials.list.copyCodeTitle' | translate:{ code: material.joinCode }">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                      </button>
                    }
                  </div>
                </div>

                <p class="material-description" *ngIf="material.description">
                  {{ material.description }}
                </p>
              </div>
            </div>

            <div class="material-meta">
              <div class="meta-item">
                <div class="meta-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                </div>
                <div class="meta-copy">
                  <span class="meta-label">{{ 'materials.list.size' | translate }}</span>
                  <span class="meta-value">{{ formatBytes(material.contentSize) }}</span>
                </div>
              </div>

              <div class="meta-item">
                <div class="meta-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 6v6l4 2" />
                  </svg>
                </div>
                <div class="meta-copy">
                  <span class="meta-label">{{ 'common.updated' | translate }}</span>
                  <span class="meta-value">{{ formatDate(material.updatedAt) }}</span>
                </div>
              </div>

              <div class="meta-item">
                <div class="meta-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                  </svg>
                </div>
                <div class="meta-copy">
                  <span class="meta-label">{{ 'common.access' | translate }}</span>
                  <span class="meta-value">
                    @if (requiresEnrollment(material)) {
                      {{ 'access.enrollmentRequired' | translate }}
                    } @else if (isOwner(material)) {
                      {{ 'quiz.roles.owner' | translate }}
                    } @else if (isCoAuthor(material)) {
                      {{ 'quiz.roles.coAuthor' | translate }}
                    } @else {
                      {{ 'access.directAvailable' | translate }}
                    }
                  </span>
                </div>
              </div>
            </div>

            <div class="material-actions">
              @if (requiresEnrollment(material) && !isEnrolled(material.id)) {
                <button
                  class="btn btn-secondary btn-small"
                  [disabled]="isEnrollmentBusy(material.id)"
                  (click)="enrollInMaterial(material)">
                  @if (isEnrolling(material.id)) {
                    {{ 'common.adding' | translate }}
                  } @else {
                    {{ 'common.add' | translate }}
                  }
                </button>
              }

              @if (requiresEnrollment(material) && isEnrolled(material.id)) {
                <button
                  class="btn btn-secondary btn-small"
                  [disabled]="isEnrollmentBusy(material.id)"
                  (click)="unenrollFromMaterial(material)">
                  @if (isUnenrolling(material.id)) {
                    {{ 'common.removing' | translate }}
                  } @else {
                    {{ 'common.remove' | translate }}
                  }
                </button>
              }

              <button
                class="btn btn-primary btn-small"
                [disabled]="(requiresEnrollment(material) && !isEnrolled(material.id)) || isEnrollmentBusy(material.id)"
                (click)="viewMaterial(material.id)">
                {{ 'materials.viewMaterial' | translate }}
              </button>

              @if (canEdit(material)) {
                <button class="btn btn-secondary btn-small" (click)="editMaterial(material.id)">
                  {{ 'common.edit' | translate }}
                </button>
              }

              @if (isOwner(material)) {
                <button class="btn btn-danger btn-small" (click)="deleteMaterial(material)">
                  {{ 'common.delete' | translate }}
                </button>
              }
            </div>
          </div>
        }
      }
    </div>
  }

  <div class="fab-container" [class.open]="fabOpen()">
    <div class="fab-menu">
      <a class="fab-item" (click)="$event.preventDefault(); createNewMaterial(); toggleFab()">
        <span class="icon-circle">+</span>
        <span class="label">{{ 'materials.newMaterial' | translate }}</span>
      </a>
      <a class="fab-item" routerLink="/lernen/deck-editor/new" (click)="toggleFab()">
        <span class="icon-circle">üóÇÔ∏è</span>
        <span class="label">{{ 'lernen.newDeck' | translate }}</span>
      </a>
    </div>

    <button class="fab"
            type="button"
            (click)="toggleFab()"
            [attr.aria-expanded]="fabOpen()"
            [attr.aria-label]="'lernen.openCreateMenu' | translate"
            aria-haspopup="menu">
      <span class="fab-lines" aria-hidden="true"></span>
    </button>
  </div>
</div>
