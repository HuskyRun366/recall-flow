<div class="deck-detail-page" *ngIf="!isLoading(); else loading">
  <ng-container *ngIf="deck(); else errorBlock">
    <div class="hero-card">
      <div class="hero-left">
        <div class="avatar">{{ deck()!.title.charAt(0).toUpperCase() }}</div>
        <div>
          <p class="eyebrow">Deck Detail</p>
          <h1>{{ deck()!.title }}</h1>
          <p class="subtitle" *ngIf="deck()!.description">{{ deck()!.description }}</p>
          <div class="badges" *ngIf="badgeConfig()">
            <app-badge [config]="badgeConfig()!" />
          </div>
        </div>
      </div>
      <div class="hero-actions">
        <ng-container *ngIf="requiresEnrollment(); else directStart">
          <button class="btn btn-secondary"
                  [disabled]="enrollState() !== 'idle' || isEnrolled()"
                  (click)="enroll()">
            {{ enrollState() === 'loading' ? 'Wird hinzugefÃ¼gtâ€¦' : (isEnrolled() ? 'HinzugefÃ¼gt' : 'HinzufÃ¼gen') }}
          </button>
          <button class="btn btn-secondary"
                  *ngIf="isEnrolled()"
                  [disabled]="enrollState() === 'removing'"
                  (click)="unenroll()">
            {{ enrollState() === 'removing' ? 'Entferneâ€¦' : 'Entfernen' }}
          </button>
          <button class="btn btn-primary"
                  [disabled]="!canStudy()"
                  (click)="startStudy()">
            Lernen
          </button>
        </ng-container>
        <ng-template #directStart>
          <button class="btn btn-primary" (click)="startStudy()">Lernen</button>
        </ng-template>
        <button class="btn btn-secondary" *ngIf="canEdit()" (click)="editDeck()">Bearbeiten</button>
        <button class="btn btn-secondary" (click)="exportDeck()" [title]="exportSuccess() ? 'Exportiert!' : 'Deck exportieren'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          {{ exportSuccess() ? 'âœ“ Exportiert' : 'Exportieren' }}
        </button>
      </div>
    </div>

    <div class="stats-grid">
      <app-stat-card [config]="{
        icon: 'svg',
        iconContent: '<path d=\'M9 11H3v9h6v-9Z M21 11h-6v9h6v-9Z M15 5H9v14h6V5Z\'/>',
        value: flashcards().length,
        label: 'Karten'
      }" />

      <app-stat-card [config]="{
        icon: 'svg',
        iconContent: '<rect x=\'3\' y=\'4\' width=\'18\' height=\'18\' rx=\'2\' ry=\'2\'/><line x1=\'16\' y1=\'2\' x2=\'16\' y2=\'6\'/><line x1=\'8\' y1=\'2\' x2=\'8\' y2=\'6\'/><line x1=\'3\' y1=\'10\' x2=\'21\' y2=\'10\'/>',
        value: formatDate(deck()!.updatedAt),
        label: 'Zuletzt aktualisiert'
      }" />

      <app-stat-card [config]="{
        icon: 'svg',
        iconContent: '<path d=\'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\'/><circle cx=\'12\' cy=\'7\' r=\'4\'/>',
        value: deck()!.ownerId === currentUser()?.uid ? 'Besitzer' : 'Zugriff',
        label: (deck()!.ownerId === currentUser()?.uid) ? '' : deck()!.visibility
      }" />

      <div class="stat-card" *ngIf="deck()!.joinCode">
        <div class="stat-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
          </svg>
        </div>
        <div>
          <div class="stat-value">
            {{ deck()!.joinCode }}
            <button class="copy-btn" (click)="copyJoinCode()" [title]="copySuccess() ? 'Kopiert!' : 'Code kopieren'">
              {{ copySuccess() ? 'âœ“' : 'ðŸ“‹' }}
            </button>
          </div>
          <div class="stat-label">Beitritts-Code</div>
        </div>
      </div>
    </div>

    <div class="card flashcards-card">
      <div class="card-header">
        <h2>Karten ({{ flashcards().length }})</h2>
      </div>
      <div class="flashcard-list">
        <div class="flashcard-item" *ngFor="let item of flashcards(); let i = index">
          <div class="fc-left">
            <div class="bubble">{{ i + 1 }}</div>
            <div class="fc-content">
              <div class="fc-front">
                <span class="fc-label">Vorne:</span>
                <span class="fc-text">{{ item.flashcard.front }}</span>
              </div>
              <div class="fc-back">
                <span class="fc-label">Hinten:</span>
                <span class="fc-text">{{ item.flashcard.back }}</span>
              </div>
            </div>
          </div>
          <div class="fc-right" *ngIf="item.progress">
            <app-level-badge [config]="{ level: item.progress.level, showLabel: true }" />
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<ng-template #loading>
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Wird geladenâ€¦</p>
  </div>
</ng-template>

<ng-template #errorBlock>
  <div class="error-state">
    {{ error() || 'Fehler beim Laden' }}
  </div>
</ng-template>
